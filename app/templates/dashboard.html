{% extends "base.html" %}

{% block title %}{{ t(g, "–û—Å–æ–±–∏—Å—Ç–∏–π –∫–∞–±—ñ–Ω–µ—Ç", "Mitglieder-Dashboard") }} - BRAMA-UAe.V2025{% endblock %}

{% block content %}
<div class="fade-in">
    <h1>{{ t(g, "–û—Å–æ–±–∏—Å—Ç–∏–π –∫–∞–±—ñ–Ω–µ—Ç", "Mitglieder-Dashboard") }}</h1>
    <p class="lead">
        {{ t(g, 
           "–í—ñ—Ç–∞—î–º–æ, " ~ current_user.first_name ~ "! –ö–µ—Ä—É–π—Ç–µ –≤–∞—à–æ—é —É—á–∞—Å—Ç—é –≤ —Å–ø—ñ–ª—å–Ω–æ—Ç—ñ BRAMA-UAe.",
           "Willkommen, " ~ current_user.first_name ~ "! Verwalten Sie Ihre Teilnahme in der BRAMA-UAe Gemeinschaft."
        ) }}
    </p>

    <div class="dashboard-grid">
        <!-- User Info Card -->
        <div class="dashboard-card">
            <h3>üë§ {{ t(g, "–ü—Ä–æ—Ñ—ñ–ª—å —É—á–∞—Å–Ω–∏–∫–∞", "Mitgliederprofil") }}</h3>
            <p><strong>{{ t(g, "Email", "E-Mail") }}:</strong> {{ current_user.email }}</p>
            <p><strong>{{ t(g, "–Ü–º'—è", "Name") }}:</strong> {{ current_user.first_name }} {{ current_user.last_name }}</p>
            <p><strong>{{ t(g, "–†–æ–ª—ñ", "Rollen") }}:</strong> 
                {% for role in current_user.roles %}
                    <span class="project-status approved" style="margin: 0.2rem;">{{ role.name }}</span>
                {% endfor %}
            </p>
            <a href="{{ url_for('dashboard.survey') }}" class="btn btn-primary">
                {{ t(g, "–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –∞–Ω–∫–µ—Ç—É", "Fragebogen ausf√ºllen") }}
            </a>
        </div>

        <!-- Quick Actions Card -->
        <div class="dashboard-card">
            <h3>‚ö° {{ t(g, "–®–≤–∏–¥–∫—ñ –¥—ñ—ó", "Schnelle Aktionen") }}</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <a href="{{ url_for('dashboard.create_project') }}" class="btn btn-success">
                    ‚ûï {{ t(g, "–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ—î–∫—Ç", "Projekt erstellen") }}
                </a>
                {% for role in current_user.roles %}
                    {% if role.name == 'admin' %}
                    <a href="{{ url_for('admin.home') }}" class="btn btn-warning">
                        ‚öôÔ∏è {{ t(g, "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è", "Administration") }}
                    </a>
                    <a href="{{ url_for('admin.meetings') }}" class="btn btn-info" style="background-color: var(--info-color); color: white;">
                        üìÖ {{ t(g, "–ó–±–æ—Ä–∏", "Versammlungen") }}
                    </a>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Projects Stats -->
        <div class="dashboard-card">
            <h3>üìä {{ t(g, "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—î–∫—Ç—ñ–≤", "Projekt-Statistiken") }}</h3>
            <p>{{ t(g, "–í—Å—å–æ–≥–æ –ø—Ä–æ—î–∫—Ç—ñ–≤", "Projekte gesamt") }}: <strong>{{ projects|length }}</strong></p>
            <p>{{ t(g, "–ù–∞ —Ä–æ–∑–≥–ª—è–¥—ñ", "In Pr√ºfung") }}: 
                <strong>{{ projects|selectattr('status', 'equalto', projects[0].status.review if projects else None)|list|length if projects else 0 }}</strong>
            </p>
            <p>{{ t(g, "–°—Ö–≤–∞–ª–µ–Ω–æ", "Genehmigt") }}: 
                <strong>{{ projects|selectattr('status', 'equalto', projects[0].status.approved if projects else None)|list|length if projects else 0 }}</strong>
            </p>
        </div>
    </div>

    <!-- Projects Section -->
    <section class="content-block">
        <h2>{{ t(g, "–ü—Ä–æ—î–∫—Ç–∏ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏", "Gemeinschaftsprojekte") }}</h2>
        
        {% if projects %}
            {% for project in projects %}
            <div class="project-card">
                <div class="project-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">{{ project.title_uk if g.lang == 'uk' else project.title_de }}</h3>
                    <span class="project-status {{ project.status.name }}">
                        {% if project.status.name == 'review' %}
                            {{ t(g, "–ù–∞ —Ä–æ–∑–≥–ª—è–¥—ñ", "In Pr√ºfung") }}
                        {% elif project.status.name == 'approved' %}
                            {{ t(g, "–°—Ö–≤–∞–ª–µ–Ω–æ", "Genehmigt") }}
                        {% elif project.status.name == 'rejected' %}
                            {{ t(g, "–í—ñ–¥—Ö–∏–ª–µ–Ω–æ", "Abgelehnt") }}
                        {% elif project.status.name == 'funded' %}
                            {{ t(g, "–ü—Ä–æ—Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∞–Ω–æ", "Finanziert") }}
                        {% endif %}
                    </span>
                </div>
                
                <p>{{ project.desc_uk if g.lang == 'uk' else project.desc_de }}</p>
                <p><small>{{ t(g, "–ê–≤—Ç–æ—Ä", "Autor") }}: {{ project.author.first_name }} {{ project.author.last_name }}</small></p>
                
                <div class="project-voting" style="margin-top: 1rem;">
                    <p><strong>{{ t(g, "–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è", "Abstimmung") }}:</strong></p>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button onclick="vote({{ project.id }}, 1)" class="btn btn-success btn-sm">
                            üëç {{ t(g, "–ó–∞", "Daf√ºr") }} ({{ project.votes|selectattr('value', 'equalto', 1)|list|length }})
                        </button>
                        <button onclick="vote({{ project.id }}, 0)" class="btn btn-warning btn-sm">
                            ü§∑ {{ t(g, "–£—Ç—Ä–∏–º.", "Enthalt.") }} ({{ project.votes|selectattr('value', 'equalto', 0)|list|length }})
                        </button>
                        <button onclick="vote({{ project.id }}, -1)" class="btn btn-danger btn-sm">
                            üëé {{ t(g, "–ü—Ä–æ—Ç–∏", "Dagegen") }} ({{ project.votes|selectattr('value', 'equalto', -1)|list|length }})
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 10px;">
                <h3>{{ t(g, "–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –ø—Ä–æ—î–∫—Ç—ñ–≤", "Noch keine Projekte vorhanden") }}</h3>
                <p>{{ t(g, "–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä—à–∏–º, —Ö—Ç–æ –∑–∞–ø—Ä–æ–ø–æ–Ω—É—î –ø—Ä–æ—î–∫—Ç –¥–ª—è —Å–ø—ñ–ª—å–Ω–æ—Ç–∏!", "Seien Sie der erste, der ein Projekt f√ºr die Gemeinschaft vorschl√§gt!") }}</p>
                <a href="{{ url_for('dashboard.create_project') }}" class="btn btn-primary">
                    {{ t(g, "–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä—à–∏–π –ø—Ä–æ—î–∫—Ç", "Erstes Projekt erstellen") }}
                </a>
            </div>
        {% endif %}
    </section>
</div>

<style>
.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.project-header {
    border-bottom: 1px solid #eee;
    padding-bottom: 0.5rem;
}
</style>

<script>
async function vote(projectId, value) {
    try {
        const response = await BRAMAUtils.vote(projectId, value);
        if (response.ok) {
            BRAMAUtils.showNotification(
                '{{ t(g, "–ì–æ–ª–æ—Å –∑–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ!", "Stimme abgegeben!") }}', 
                'success'
            );
            // Reload page to update vote counts
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error('Vote failed');
        }
    } catch (error) {
        BRAMAUtils.showNotification(
            '{{ t(g, "–ü–æ–º–∏–ª–∫–∞ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è", "Abstimmungsfehler") }}', 
            'danger'
        );
    }
}
</script>
{% endblock %}