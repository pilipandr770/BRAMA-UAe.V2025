{% extends "base.html" %}

{% block title %}{{ t(g, "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è", "Administration") }} - BRAMA-UAe.V2025{% endblock %}

{% block content %}
<div class="fade-in">
    <h1>‚öôÔ∏è {{ t(g, "–ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞", "Administrator Panel") }}</h1>
    
    <div class="dashboard-grid">
        <!-- Statistics Card -->
        <div class="dashboard-card">
            <h3>üìä {{ t(g, "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "Statistiken") }}</h3>
            <p>{{ t(g, "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤", "Benutzer") }}: <strong>{{ users|length }}</strong></p>
            <p>{{ t(g, "–ö–æ–Ω—Ç–µ–Ω—Ç-–±–ª–æ–∫—ñ–≤", "Content-Bl√∂cke") }}: <strong>{{ blocks|length }}</strong></p>
            <p>{{ t(g, "–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π", "Transaktionen") }}: <strong>{{ txs|length }}</strong></p>
            <p>{{ t(g, "–ó–±–æ—Ä—ñ–≤", "Versammlungen") }}: <strong>{{ meetings|length }}</strong></p>
        </div>

        <!-- Quick Actions Card -->
        <div class="dashboard-card">
            <h3>‚ö° {{ t(g, "–®–≤–∏–¥–∫—ñ –¥—ñ—ó", "Schnelle Aktionen") }}</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button onclick="showCreateBlock()" class="btn btn-primary">
                    ‚ûï {{ t(g, "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç", "Inhalt erstellen") }}
                </button>
                <button onclick="showAddFinance()" class="btn btn-success">
                    üí∞ {{ t(g, "–î–æ–¥–∞—Ç–∏ —Ñ—ñ–Ω–∞–Ω—Å–∏", "Finanzen hinzuf√ºgen") }}
                </button>
                <button onclick="showCreateMeeting()" class="btn btn-info" style="background-color: var(--info-color); color: white;">
                    üìÖ {{ t(g, "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–±–æ—Ä–∏", "Versammlung erstellen") }}
                </button>
                <a href="{{ url_for('admin.meetings') }}" class="btn btn-warning">
                    üìã {{ t(g, "–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–±–æ—Ä–∞–º–∏", "Versammlungen verwalten") }}
                </a>
            </div>
        </div>
    </div>

    <!-- Users Management -->
    <section class="content-block">
        <h2>üë• {{ t(g, "–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏", "Benutzerverwaltung") }}</h2>
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>{{ t(g, "Email", "E-Mail") }}</th>
                        <th>{{ t(g, "–Ü–º'—è", "Name") }}</th>
                        <th>{{ t(g, "–†–æ–ª—ñ", "Rollen") }}</th>
                        <th>{{ t(g, "–î—ñ—ó", "Aktionen") }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.first_name }} {{ user.last_name }}</td>
                        <td>
                            {% for role in user.roles %}
                                <span class="project-status approved">{{ role.name }}</span>
                            {% endfor %}
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('admin.set_role') }}" style="display: inline;">
                                <input type="hidden" name="user_id" value="{{ user.id }}">
                                <select name="role" style="padding: 0.25rem;">
                                    <option value="member">member</option>
                                    <option value="admin">admin</option>
                                    <option value="founder">founder</option>
                                </select>
                                <button type="submit" class="btn btn-sm btn-primary">{{ t(g, "–î–æ–¥–∞—Ç–∏ —Ä–æ–ª—å", "Rolle hinzuf√ºgen") }}</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- Content Blocks Management -->
    <section class="content-block">
        <h2>üìÑ {{ t(g, "–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º", "Content-Verwaltung") }}</h2>
        {% for block in blocks %}
        <div class="project-card">
            <h3>{{ block.title_uk or block.title_de }} ({{ block.block_type }})</h3>
            <p>{{ (block.body_uk if g.lang == 'uk' else block.body_de)[:100] }}...</p>
            
            {% if block.block_type == 'gallery' %}
            <div class="gallery" style="margin: 1rem 0;">
                {% for image in block.images %}
                <div class="gallery-item" style="max-width: 200px;">
                    <img src="{{ url_for('admin.image_raw', iid=image.id) }}" alt="{{ image.caption_uk or image.caption_de }}" style="width: 100%; height: 120px; object-fit: cover;">
                </div>
                {% endfor %}
            </div>
            
            <form method="POST" action="{{ url_for('admin.add_block_image', bid=block.id) }}" enctype="multipart/form-data" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                <h4>{{ t(g, "–î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è", "Bild hinzuf√ºgen") }}</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                    <input type="file" name="image" accept="image/*" required class="form-control">
                    <input type="text" name="caption_uk" placeholder="{{ t(g, '–ü—ñ–¥–ø–∏—Å (—É–∫—Ä)', 'Beschreibung (ukr)') }}" class="form-control">
                    <input type="text" name="caption_de" placeholder="{{ t(g, '–ü—ñ–¥–ø–∏—Å (–Ω—ñ–º)', 'Beschreibung (de)') }}" class="form-control">
                    <button type="submit" class="btn btn-primary">{{ t(g, "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏", "Hochladen") }}</button>
                </div>
            </form>
            {% endif %}
        </div>
        {% endfor %}
    </section>

    <!-- Financial Transactions -->
    <section class="content-block">
        <h2>üí∞ {{ t(g, "–§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó", "Finanzielle Transaktionen") }}</h2>
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>{{ t(g, "–î–∞—Ç–∞", "Datum") }}</th>
                        <th>{{ t(g, "–¢–∏–ø", "Typ") }}</th>
                        <th>{{ t(g, "–°—É–º–∞", "Betrag") }}</th>
                        <th>{{ t(g, "–í–∞–ª—é—Ç–∞", "W√§hrung") }}</th>
                        <th>{{ t(g, "–û–ø–∏—Å", "Beschreibung") }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in txs %}
                    <tr>
                        <td>{{ tx.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <span class="project-status {{ 'approved' if tx.type == 'income' else 'review' }}">
                                {{ t(g, "–î–æ—Ö—ñ–¥" if tx.type == 'income' else "–í–∏—Ç—Ä–∞—Ç–∏", "Einnahmen" if tx.type == 'income' else "Ausgaben") }}
                            </span>
                        </td>
                        <td>{{ "%.2f"|format(tx.amount) }}</td>
                        <td>{{ tx.currency }}</td>
                        <td>{{ tx.description }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- Recent Meetings -->
    {% if meetings %}
    <section class="content-block">
        <h2>üìÖ {{ t(g, "–û—Å—Ç–∞–Ω–Ω—ñ –∑–±–æ—Ä–∏", "Letzte Versammlungen") }}</h2>
        {% for meeting in meetings %}
        <div class="project-card">
            <h3>{{ meeting.title }}</h3>
            <p>{{ meeting.description }}</p>
            <p><small>{{ t(g, "–î–∞—Ç–∞", "Datum") }}: {{ meeting.starts_at.strftime('%Y-%m-%d %H:%M') }}</small></p>
        </div>
        {% endfor %}
    </section>
    {% endif %}
</div>

<!-- Modal Forms -->
<!-- Create Content Block Modal -->
<div id="createBlockModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90%; overflow-y: auto;">
        <h3>{{ t(g, "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç-–±–ª–æ–∫", "Content-Block erstellen") }}</h3>
        <form method="POST" action="{{ url_for('admin.create_block') }}">
            <div class="form-group">
                <label>{{ t(g, "–¢–∏–ø –±–ª–æ–∫—É", "Block-Typ") }}</label>
                <select name="block_type" class="form-control">
                    <option value="info">{{ t(g, "–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∏–π", "Informationen") }}</option>
                    <option value="gallery">{{ t(g, "–ì–∞–ª–µ—Ä–µ—è", "Galerie") }}</option>
                    <option value="projects">{{ t(g, "–ü—Ä–æ—î–∫—Ç–∏", "Projekte") }}</option>
                </select>
            </div>
            <div class="form-group">
                <label>{{ t(g, "–ó–∞–≥–æ–ª–æ–≤–æ–∫ (—É–∫—Ä)", "Titel (ukr)") }}</label>
                <input type="text" name="title_uk" class="form-control">
            </div>
            <div class="form-group">
                <label>{{ t(g, "–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω—ñ–º)", "Titel (de)") }}</label>
                <input type="text" name="title_de" class="form-control">
            </div>
            <div class="form-group">
                <label>{{ t(g, "–ó–º—ñ—Å—Ç (—É–∫—Ä)", "Inhalt (ukr)") }}</label>
                <textarea name="body_uk" class="form-control" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>{{ t(g, "–ó–º—ñ—Å—Ç (–Ω—ñ–º)", "Inhalt (de)") }}</label>
                <textarea name="body_de" class="form-control" rows="4"></textarea>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary">{{ t(g, "–°—Ç–≤–æ—Ä–∏—Ç–∏", "Erstellen") }}</button>
                <button type="button" onclick="hideModal('createBlockModal')" class="btn btn-secondary" style="background: #6c757d; color: white;">{{ t(g, "–°–∫–∞—Å—É–≤–∞—Ç–∏", "Abbrechen") }}</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Finance Modal -->
<div id="addFinanceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 500px;">
        <h3>{{ t(g, "–î–æ–¥–∞—Ç–∏ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—É –æ–ø–µ—Ä–∞—Ü—ñ—é", "Finanzielle Transaktion hinzuf√ºgen") }}</h3>
        <form method="POST" action="{{ url_for('admin.add_finance') }}">
            <div class="form-group">
                <label>{{ t(g, "–¢–∏–ø", "Typ") }}</label>
                <select name="type" class="form-control">
                    <option value="income">{{ t(g, "–î–æ—Ö—ñ–¥", "Einnahmen") }}</option>
                    <option value="expense">{{ t(g, "–í–∏—Ç—Ä–∞—Ç–∏", "Ausgaben") }}</option>
                </select>
            </div>
            <div class="form-group">
                <label>{{ t(g, "–°—É–º–∞", "Betrag") }}</label>
                <input type="number" step="0.01" name="amount" class="form-control" required>
            </div>
            <div class="form-group">
                <label>{{ t(g, "–í–∞–ª—é—Ç–∞", "W√§hrung") }}</label>
                <select name="currency" class="form-control">
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                    <option value="UAH">UAH</option>
                </select>
            </div>
            <div class="form-group">
                <label>{{ t(g, "–û–ø–∏—Å", "Beschreibung") }}</label>
                <textarea name="description" class="form-control" rows="3"></textarea>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary">{{ t(g, "–î–æ–¥–∞—Ç–∏", "Hinzuf√ºgen") }}</button>
                <button type="button" onclick="hideModal('addFinanceModal')" class="btn btn-secondary" style="background: #6c757d; color: white;">{{ t(g, "–°–∫–∞—Å—É–≤–∞—Ç–∏", "Abbrechen") }}</button>
            </div>
        </form>
    </div>
</div>

<!-- Create Meeting Modal -->
<div id="createMeetingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 500px;">
        <h3>{{ t(g, "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–±–æ—Ä–∏", "Versammlung erstellen") }}</h3>
        <form method="POST" action="{{ url_for('admin.create_meeting') }}">
            <div class="form-group">
                <label>{{ t(g, "–ù–∞–∑–≤–∞", "Titel") }}</label>
                <input type="text" name="title" class="form-control" required>
            </div>
            <div class="form-group">
                <label>{{ t(g, "–û–ø–∏—Å", "Beschreibung") }}</label>
                <textarea name="description" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>{{ t(g, "–î–∞—Ç–∞ —Ç–∞ —á–∞—Å", "Datum und Uhrzeit") }}</label>
                <input type="datetime-local" name="starts_at" class="form-control" required>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary">{{ t(g, "–°—Ç–≤–æ—Ä–∏—Ç–∏", "Erstellen") }}</button>
                <button type="button" onclick="hideModal('createMeetingModal')" class="btn btn-secondary" style="background: #6c757d; color: white;">{{ t(g, "–°–∫–∞—Å—É–≤–∞—Ç–∏", "Abbrechen") }}</button>
            </div>
        </form>
    </div>
</div>

<script>
function showCreateBlock() {
    document.getElementById('createBlockModal').style.display = 'block';
}

function showAddFinance() {
    document.getElementById('addFinanceModal').style.display = 'block';
}

function showCreateMeeting() {
    document.getElementById('createMeetingModal').style.display = 'block';
}

function hideModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.style.position === 'fixed') {
        hideModal(e.target.id);
    }
});
</script>
{% endblock %}